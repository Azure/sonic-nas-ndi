<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE CLISH_MODULE [
<!ENTITY SUBTREE_FILTER                          "Filter_Type:SUBTREE">
<!ENTITY NAMESPACE_FILTER                        "Filter_Namespace:http://www.dellemc.com/networking/os10/dell-span">
<!ENTITY PORTMON                                 "/sessions">
<!ENTITY PORTMON_SESSION                         "&PORTMON;/session">
<!ENTITY PORTMON_SESSION_ID                      "&PORTMON;/session/id=${v_sessionid}">
<!ENTITY PORTMON_SESSION_DESC                    "&PORTMON_SESSION_ID;,&PORTMON_SESSION;/descript">
<!ENTITY PORTMON_SESSION_SHUT                    "&PORTMON_SESSION_ID;,&PORTMON_SESSION;/disable">
<!ENTITY PORTMON_SPAN_SOURCE_IF                  "&PORTMON_SESSION;/source-intf">
<!ENTITY PORTMON_SPAN_SOURCE_IF_NAME             "&PORTMON_SESSION_ID;,&PORTMON_SESSION;/source-intf/name">
<!ENTITY PORTMON_SPAN_SOURCE_PO_IF               "&PORTMON_SESSION;/source-intf">
<!ENTITY PORTMON_SPAN_SOURCE_PO_IF_NAME          "&PORTMON_SESSION_ID;,&PORTMON_SESSION;/source-intf/name">
<!ENTITY PORTMON_SPAN_SOURCE_VLAN_IF             "&PORTMON_SESSION;/source-intf">
<!ENTITY PORTMON_SPAN_SOURCE_VLAN_IF_NAME        "&PORTMON_SESSION_ID;,&PORTMON_SESSION;/source-intf/name">
<!ENTITY PORTMON_SPAN_DEST_IF_NAME               "&PORTMON_SESSION_ID;,&PORTMON_SESSION;/destination-interface">
<!ENTITY PORTMON_SPAN_DEST_PO_IF_NAME            "&PORTMON_SESSION_ID;,&PORTMON_SESSION;/destination-interface">
<!ENTITY PORTMON_SPAN_DEST_REMOTE_VLAN           "&PORTMON_SESSION_ID;,&PORTMON_SESSION;/destination-remote-vlan">


<!ENTITY SPAN-PREF "dell-span">
<!ENTITY SPAN_NS "&SPAN-PREF;=http://www.dellemc.com/networking/os10/dell-span">
<!ENTITY SPAN_INTF_NS "urn:ietf:params:xml:ns:yang:ietf-interfaces,&SPAN_NS;">
<!ENTITY SPAN_INTF "/interfaces/interface">
<!ENTITY SPAN_INTF_INFO "&SPAN_INTF;/&SPAN-PREF;:remote-span">
<!ENTITY SPAN_GLOBAL_RSPAN "&SPAN_INTF_INFO;/&SPAN-PREF;:remote-span-vlan">
<!ENTITY SPAN_IFACE "&SPAN_INTF;/name">
<!ENTITY SPAN_INTF_RNG "/interfaces/interface[]">
<!ENTITY SPAN_INTF_INFO_RNG "&SPAN_INTF_RNG;/&SPAN-PREF;:remote-span">
<!ENTITY SPAN_GLOBAL_RSPAN_RNG "&SPAN_INTF_INFO_RNG;/&SPAN-PREF;:remote-span-vlan">
<!ENTITY SPAN_IFACE_RNG "&SPAN_INTF_RNG;/name">
]>
<CLISH_MODULE
    xmlns="http://www.dellemc.com/force10/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xsi:schemaLocation="http://www.dellemc.com/force10/XMLSchema
                        http://www.dellemc.com/force10/XMLSchema/clish.xsd"
    >

    <!--=================================================================-->
    <!-- ********************************************************************** -->
    <!-- *  SHOW COMMANDS                                                  * -->
    <!-- *  View : enable-view                                             * -->
    <!-- ********************************************************************** -->
    <VIEW
        name="enable-view"
        >
        <!--show running-configuration monitor session -->
        <COMMAND
            name="show running-configuration monitor"
            help="Current operating monitor session configuration"
            yang_filter="&SUBTREE_FILTER;;Filter_Conditions:/sessions;&NAMESPACE_FILTER;"
            db_mode="configure-monitor"
            >
            <ACTION builtin="clish_extn"> </ACTION>
        </COMMAND>

        <!--show candidate-configuration monitor session -->
        <COMMAND
            name="show candidate-configuration monitor"
            help="Current candidate monitor session configuration"
            yang_filter="&SUBTREE_FILTER;;Filter_Conditions:/sessions;&NAMESPACE_FILTER;"
            db_mode="configure-monitor"
            >
            <ACTION builtin="clish_extn"> </ACTION>
        </COMMAND>

    </VIEW>

    <!--=======================================================-->
    <VIEW
        name="enable-view"
        >
        <!-- show monitor session [all|<id>] -->
        <COMMAND
            name="show monitor"
            help="Show port monitoring sessions"
            operation="get"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            template="show_monitor.xsl"
            >
            <PARAM
                name="session"
                help="Monitor session id"
                mode="subcommand"
                ptype="SUBCOMMAND"
                >
                <PARAM
                    name="subcommands"
                    help="subcommands"
                    mode="switch"
                    ptype="SUBCOMMAND"
                    >
                    <PARAM
                        name="session_id"
                        help="Monitor session id"
                        ptype="RANGE_1_18"
                        yang_filter="&SUBTREE_FILTER;;Filter_Conditions:/sessions/session/id=${session_id};&NAMESPACE_FILTER;|&SUBTREE_FILTER;;Filter_Conditions:/oper-data/session/id=${session_id};&NAMESPACE_FILTER;"
                        />
                    <PARAM
                        name="all"
                        help="Monitor session id"
                        ptype="SUBCOMMAND"
                        mode="subcommand"
                        yang_filter="&SUBTREE_FILTER;;Filter_Conditions:/sessions;&NAMESPACE_FILTER;|&SUBTREE_FILTER;;Filter_Conditions:/oper-data;&NAMESPACE_FILTER;"
                        />
                </PARAM>
            </PARAM>
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
    </VIEW>
    <!--=======================================================-->
    <!--                Config MODE                            -->
    <!--=======================================================-->
    <VIEW
        name="configure-view"
        >
        <!-- monitor -->
        <COMMAND
            name="monitor"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            help="Create a session for monitoring traffic"
            />
        <!-- monitor session <id> -->
        <COMMAND
            name="monitor session"
            help="Create a session for monitoring traffic"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            viewid="v_sessionid=${session_id};v_spantype=${spantype}"
            view="configure-monitor-view"
            yang_key="/sessions/session/id"
            >
            <PARAM
                name="session_id"
                help="Monitor session id"
                ptype="RANGE_1_18"
                prompt_fn="span_check_type"
                prompt_oper="/sessions/session/id=${session_id},/sessions/session/monitortype"
                prompt_str="${spantype}"
                yang_name="/sessions/session/id=${session_id}"
                >
                <!-- monitor session <id> type [local|rspan-source|rspan-destination|erspan-source]-->
                <PARAM
                    name="type"
                    help="Monitor session type"
                    optional="true"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    >
                    <PARAM
                        name="spantype"
                        help="SPAN/RSPAN/ERSPAN sessions"
                        default="local"
                        ptype="SPANMODE"
                        yang_name="/sessions/session/monitortype=${spantype}"
                        >
                    </PARAM>
                </PARAM>
            </PARAM>
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        <!-- monitor erspan origin ip-address <ip> global -->
        <!--
        <COMMAND
            name="monitor erspan"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            help="Configure Ethernet ERSPAN sessions"
            >
            <PARAM
                name="origin"
                help="Configure the erspan origin ip address"
                mode="subcommand"
                ptype="SUBCOMMAND"
                >
                <PARAM
                    name="ip-address"
                    help="Configure global origin IP address"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    >
                    <PARAM
                        name="ip_addr"
                        help="IP address"
                        ptype="IP_ADDR"
                        yang_name="/erspan-source-ip=${ip_addr}"
                        >
                        <PARAM
                            name="global"
                            help="Configure globally"
                            ptype="SUBCOMMAND"
                            mode="subcommand"
                            />
                    </PARAM>
                </PARAM>
            </PARAM>
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        -->
        <!-- no monitor -->
        <COMMAND
            name="no monitor"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            help="Delete a session for monitoring traffic with port monitoring"
            />
        <!-- no monitor session <id> -->
        <COMMAND
            name="no monitor session"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            help="Create a session for monitoring traffic with port monitoring"
            >
            <PARAM
                name="subcommands"
                help="subcommands"
                mode="switch"
                ptype="SUBCOMMAND"
                >
                <PARAM
                    name="all"
                    help="Delete all monitor sessions"
                    mode="subcommand"
                    ptype="SUBCOMMAND"
                    sub_oper_yang="remove:sessions"
                    yang_name="/sessions"
                    />
                <PARAM
                    name="session_id"
                    help="Monitor session no"
                    ptype="RANGE_1_18"
                    sub_oper_yang="remove:session"
                    yang_name="/sessions/session,/sessions/session/id=${session_id}"
                    />
            </PARAM>
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
    </VIEW>
    <!--=======================================================-->
    <!--                Config Vlan MODE                       -->
    <!--=======================================================-->
    <VIEW
        name="configure-vlan-view"
        >
        <COMMAND
            name="remote-span"
            help="Configure this vlan as RSPAN vlan"
            namespace="&SPAN_INTF_NS;"
            yang_name="&SPAN_IFACE;=vlan${vlan_id}, &SPAN_GLOBAL_RSPAN;=true"

            operation="edit-config"
            >
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        <COMMAND
            name="no remote-span"
            help="Unconfigure this vlan as RSPAN vlan"
            namespace="&SPAN_INTF_NS;"
            sub_oper_yang="remove:remote-span"
            yang_name="&SPAN_IFACE;=vlan${vlan_id}, &SPAN_GLOBAL_RSPAN;=false"
			operation="edit-config"
            >
            <ACTION
                builtin="clish_extn"
                />
         </COMMAND>
    </VIEW>
    <!--=======================================================-->
    <!--                Config Monitor MODE                     -->
    <!--=======================================================-->
    <VIEW
        name="configure-monitor-view"
        prompt="${SYSTEM_NAME}(conf-mon-${v_spantype}-${v_sessionid})# "
        depth="2"
        >
        <!-- Inheritance -->
        <NAMESPACE
            ref="configure-view"
            help="false"
            completion="false"
            />
        <!-- no shut -->
        <COMMAND
            name="no shut"
            help="Enables the monitor session"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            default_oper="merge"
            add_config_entry = "true"
            yang_name="&PORTMON_SESSION_SHUT;=false"
            >
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        <!-- no -->
        <COMMAND
            name="no"
            help="Negate a command or set its defaults"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            >
            <PARAM
                name="allnocommands"
                help="no commands"
                ptype="SUBCOMMAND"
                mode="switch"
                >
                <!-- no description -->
                <PARAM
                    name="description"
                    help="Description string"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    yang_name="&PORTMON_SESSION_DESC;"
                    >
                </PARAM>
                <!-- no destination interface <int> -->
                <PARAM
                    name="destination"
                    help="Destination configuration"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    >
                    <PARAM
                        name="dst-subcommands"
                        help="subcommands"
                        mode="switch"
                        ptype="SUBCOMMAND"
                        >
                        <PARAM
                            name="interface"
                            help="Select an interface"
                            ptype="SUBCOMMAND"
                            mode="subcommand"
                            test="'${v_spantype}' = 'local'"
                            default_oper="merge"
                            >
                            <MACRO name="SPAN_DEST_IF" arg="remove" />
                        </PARAM>
                        <PARAM
                            name="remote-vlan"
                            help="Remote span vlan id"
                            test="'${v_spantype}' = 'rspan-source'"
                            ptype="SUBCOMMAND"
                            mode="subcommand"
                            >
                            <PARAM
                                name="vlan_id"
                                help="remote span vlan id"
                                ptype="VLAN_ID"
                                sub_oper_yang="remove:destination-remote-vlan"
                                yang_name="&PORTMON_SPAN_DEST_REMOTE_VLAN;=vlan${vlan_id}"
                                />
                        </PARAM>
                    </PARAM>
                </PARAM>
                <!-- no flow-based enable -->
                <PARAM
                    name="flow-based"
                    help="Flow based monitoring commands"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    >
                    <MACRO name="MACRO_FLOW_ENABLE" arg="remove" />
                </PARAM>
                <!-- no source interface <int> -->
                <!-- no source vlan -->
                <PARAM
                    name="source"
                    help="Source configuration"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    >
                    <MACRO name="SPAN_SOURCE_IF" arg="remove" />
                </PARAM>
            </PARAM>
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        <!-- description [line] -->
        <COMMAND
            name="description"
            help="Description of this monitor session"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            >
            <PARAM
                name="mirr-desc"
                help="Enter the description string(can include spaces)"
                ptype="STRING"
                yang_name="&PORTMON_SESSION_DESC;=${mirr-desc}"
                />
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        <!-- destination interface <int> -->
        <COMMAND
            name="destination"
            help="Destination configuration"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            >
            <PARAM
                name="subcommands"
                help="subcommands"
                mode="switch"
                ptype="SUBCOMMAND"
                >
                <PARAM
                    name="interface"
                    help="Select an interface"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    default_oper="merge"
                    test="'${v_spantype}' = 'local'"
                    >
                    <MACRO name="SPAN_DEST_IF" arg="merge" />
                </PARAM>
                <!-- destination remote-vlan <vlanid> -->
                <PARAM
                    name="remote-vlan"
                    help="Remote span vlan id"
                    ptype="SUBCOMMAND"
                    mode="subcommand"
                    test="'${v_spantype}' = 'rspan-source'"
                    >
                    <PARAM
                        name="vlan_id"
                        help="remote span vlan id"
                        ptype="VLAN_ID"
                        yang_name="&PORTMON_SPAN_DEST_REMOTE_VLAN;=vlan${vlan_id}"
                        />
                </PARAM>
            </PARAM>
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        <!-- flow-based enable -->
        <COMMAND
            name="flow-based"
            help="Flow based monitoring commands"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            >
            <MACRO name="MACRO_FLOW_ENABLE" arg="merge" />
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        <!-- shut -->
        <COMMAND
            name="shut"
            help="Disables the monitor session"
            ptype="SUBCOMMAND"
            mode="subcommand"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            yang_name="&PORTMON_SESSION_SHUT;=true"
            >
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        <!-- source interface <int> direction <both|rx|tx> -->
        <!-- source vlan <id> direction <both|rx|tx> -->
        <COMMAND
            name="source"
            help="Source configuration"
            operation="edit-config"
            namespace="http://www.dellemc.com/networking/os10/dell-span"
            >
            <MACRO name="SPAN_SOURCE_IF" arg="merge" />
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>

        <VAR name="var_if_direction" dynamic="true">
            <ACTION>if [ "${if_direction}" = "none" ] ; then echo -n ",/sessions/session/source-intf/direction=both"; fi</ACTION>
        </VAR>

        <VAR name="var_po_direction" dynamic="true">
            <ACTION>if [ "${po_direction}" = "none" ] ; then echo -n ",/sessions/session/source-intf/direction=both"; fi</ACTION>
        </VAR>

    </VIEW>
    <!--=======================================================-->
    <!--                Config Vlan Range MODE                       -->
    <!--=======================================================-->
    <VIEW
        name="configure-vlan-range-view"
        >
        <COMMAND
            name="remote-span"
            help="Configure this vlan as RSPAN vlan"
            namespace="&SPAN_INTF_NS;"
            yang_name="&SPAN_IFACE_RNG;=${vlan_id},&SPAN_GLOBAL_RSPAN_RNG;=true"
            operation="edit-config"
            >
            <ACTION
                builtin="clish_extn"
                />
        </COMMAND>
        <COMMAND
            name="no remote-span"
            help="Unconfigure this vlan as RSPAN vlan"
            namespace="&SPAN_INTF_NS;"
            sub_oper_yang="remove:remote-span"
            yang_name="&SPAN_IFACE_RNG;=${vlan_id},&SPAN_GLOBAL_RSPAN_RNG;=false"
			operation="edit-config"
            >
            <ACTION
                builtin="clish_extn"
                />
         </COMMAND>
    </VIEW>
</CLISH_MODULE>
